name: Build Archiso and Archive to Main

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    container:
      image: archlinux:latest
      options: --privileged

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Environment and Install Packages
        run: |
          # 1. 系统配置和安装包
          pacman -Syu --noconfirm --noprogressbar
          pacman-key --init
          pacman-key --populate archlinux
          echo -e "\n[archlinuxcn]\nSigLevel = Optional TrustAll\nServer = https://mirrors.ustc.edu.cn/archlinuxcn/\$arch" >> /etc/pacman.conf
          pacman -Sy --noconfirm --noprogressbar git archlinuxcn-keyring archiso sudo grub libisoburn mtools dosfstools squashfs-tools efibootmgr
          pacman-key --lsign-key "F9F9FA97A403F63E"
          
          # 2. 然后配置 Git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Prepare airootfs Placeholder
        run: |
          mkdir -p airootfs/etc/pacman.d/scripts airootfs/root airootfs/usr/local/bin
          FILES=("airootfs/etc/shadow" "airootfs/root/.automated_script.sh" "airootfs/etc/pacman.d/scripts/customize_airootfs.sh" "airootfs/usr/local/bin/choose-mirror" "airootfs/usr/local/bin/Installation_guide" "airootfs/usr/local/bin/livecd-sound" "airootfs/usr/local/bin/remove-nvidia" "airootfs/usr/local/bin/removeun")
          for file in "${FILES[@]}"; do
            if [ ! -f "$file" ]; then
              touch "$file"
              [[ "$file" == *.sh || "$file" == */bin/* ]] && echo "#!/bin/bash" > "$file"
            fi
          done

      - name: Build ISO
        run: |
          rm -rf out
          sudo mkarchiso -v -w /tmp/archiso-work -o ./out ./
          
          END_TIME=$(date +"%Y%m%d_%H%M%S")
          echo "ARCHIVE_FOLDER=$END_TIME" >> $GITHUB_ENV
          mkdir -p "$END_TIME"
          
          if [ -d "out" ]; then
            mv out/*.iso "$END_TIME"/
          fi

      - name: Cleanup and Push to Main
        run: |
          # 1. 清理工作目录
          sudo umount -R /tmp/archiso-work 2>/dev/null || true
          sudo rm -rf /tmp/archiso-work
          sudo rm -rf out
          
          # 2. 提交并推送
          if [ -d "${{ env.ARCHIVE_FOLDER }}" ]; then
            git add "${{ env.ARCHIVE_FOLDER }}"
            git commit -m "archive: ISO build completed at ${{ env.ARCHIVE_FOLDER }}"
            git push origin main
          else
            echo "Build failed or no ISO found, skipping push."
            exit 1
          fi
