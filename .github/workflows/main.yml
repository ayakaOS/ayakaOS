name: Build Archiso and Push to Main

on:
  push:
    branches:
      - main
  workflow_dispatch:

# 必须赋予写权限，否则无法推送 ISO 回仓库
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    container:
      image: archlinux:latest
      options: --privileged

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取完整提交历史以便推送

      - name: Configure Repos and Keys
        run: |
          pacman-key --init
          pacman-key --populate archlinux
          
          # 添加 CachyOS 和 ArchLinuxCN 源
          echo -e "\n[cachyos]\nSigLevel = Optional TrustAll\nServer = https://mirrors.ustc.edu.cn/cachyos/repo/$arch/$repo" >> /etc/pacman.conf
          echo -e "\n[archlinuxcn]\nSigLevel = Optional TrustAll\nServer = https://mirrors.ustc.edu.cn/archlinuxcn/\$arch" >> /etc/pacman.conf
          
          pacman -Syu --noconfirm --noprogressbar
          pacman -S --noconfirm --noprogressbar archlinuxcn-keyring archiso sudo git grub libisoburn mtools dosfstools squashfs-tools efibootmgr
          pacman-key --lsign-key "F9F9FA97A403F63E"

      - name: Auto-Fix Packages (Avoid Interactivity)
        run: |
          PACKAGES_FILE="packages.x86_64"
          if [ -f "$PACKAGES_FILE" ]; then
            # 移除可能冲突的包
            sed -i '/dkms/d; /nvidia/d' $PACKAGES_FILE
            # 注入 Provider 解决交互提示，并加入预编译驱动
            {
              echo "iptables-nft"
              echo "fcitx5-im"
              echo "qt6-multimedia-ffmpeg"
              echo "noto-fonts"
              echo "phonon-qt6-vlc"
              echo "crun"
              echo "linux-cachyos"
              echo "linux-cachyos-nvidia-open"
            } >> $PACKAGES_FILE
          fi

      - name: Prepare airootfs and pacman.conf
        run: |
          # 同步项目配置
          if [ -f "pacman.conf" ]; then
            sed -i '/\[archlinuxcn\]/,/\[/ s/SigLevel = .*/SigLevel = Optional TrustAll/' pacman.conf
            grep -q "\[cachyos\]" pacman.conf || echo -e "\n[cachyos]\nSigLevel = Optional TrustAll\nServer = https://mirror.isoc.org.il/pub/cachyos/repo/\$arch" >> pacman.conf
          fi
          # 补齐 profiledef.sh 中定义的文件
          mkdir -p airootfs/etc/pacman.d/scripts airootfs/root airootfs/usr/local/bin
          FILES=("airootfs/etc/shadow" "airootfs/root/.automated_script.sh" "airootfs/etc/pacman.d/scripts/customize_airootfs.sh" "airootfs/usr/local/bin/choose-mirror" "airootfs/usr/local/bin/Installation_guide" "airootfs/usr/local/bin/livecd-sound" "airootfs/usr/local/bin/remove-nvidia" "airootfs/usr/local/bin/removeun")
          for file in "${FILES[@]}"; do
            if [ ! -f "$file" ]; then
              touch "$file"
              [[ "$file" == *.sh || "$file" == */bin/* ]] && echo "#!/bin/bash" > "$file"
            fi
          done

      - name: Build ISO
        run: |
          rm -rf out
          sudo mkarchiso -v -w /tmp/archiso-work -o ./out ./
          
          # 获取结束时间并创建文件夹
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          echo "TIMESTAMP_FOLDER=$TIMESTAMP" >> $GITHUB_ENV
          mkdir -p "$TIMESTAMP"
          
          # 把生成的 ISO 移动到该文件夹
          mv out/*.iso "$TIMESTAMP"/

      - name: Cleanup and Push to Main
        run: |
          # 彻底清理工作目录和输出目录（按要求删除 work 和 out）
          sudo umount -R /tmp/archiso-work 2>/dev/null || true
          sudo rm -rf /tmp/archiso-work
          sudo rm -rf out
          
          # 配置 Git 机器人信息
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # 添加新创建的时间戳文件夹并推送到 main
          git add "${{ env.TIMESTAMP_FOLDER }}"
          git commit -m "chore: 归档 ISO 构建结果 - ${{ env.TIMESTAMP_FOLDER }}"
          git push origin main

      - name: Upload as Artifact (Optional)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ISO-${{ env.TIMESTAMP_FOLDER }}
          path: "${{ env.TIMESTAMP_FOLDER }}/*.iso"
