name: Build Archiso and Upload as Attachment

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged # 必须开启

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          # 1. 强制更新并安装必要组件
          pacman -Syu --noconfirm
          pacman -S --noconfirm archiso sudo git grub libisoburn mtools dosfstools squashfs-tools
          
          # 2. 初始化 pacman 密钥 (构建环境需要)
          pacman-key --init
          pacman-key --populate archlinux

      - name: Build ISO
        run: |
          # 清理之前的残留（如果有）
          rm -rf out
          
          # 关键点：使用 -w 将工作目录设为容器内的 /tmp/archiso-work
          # 这能绕过 GitHub Workspace 路径导致的 "Outside of valid path" 权限错误
          sudo mkarchiso -v -w /tmp/archiso-work -o ./out ./
          
          # 获取结束时间戳
          TIMESTAMP=$(date +"%Y%m%d_%H%M")
          
          # 重命名 ISO 并保存文件名到环境变量
          if [ -d "out" ]; then
            cd out
            for f in *.iso; do
              NEW_NAME="${TIMESTAMP}-$f"
              mv "$f" "$NEW_NAME"
              echo "ISO_FILENAME=$NEW_NAME" >> $GITHUB_ENV
            done
            cd ..
          fi

      - name: Upload ISO as Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ISO_FILENAME }}
          path: out/*.iso
          retention-days: 7

      - name: Post-Build Cleanup
        if: always()
        run: |
          # 清理本地和 /tmp 中的临时文件
          sudo rm -rf out
          sudo rm -rf /tmp/archiso-work
